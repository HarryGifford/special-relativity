(self.webpackChunksr_frontend=self.webpackChunksr_frontend||[]).push([[31],{9031:(e,t,a)=>{"use strict";a.r(t);var n=a(7734);a(6790);const i=async e=>{const t=await fetch(e);if(!t.ok)throw new Error(t.statusText);return t.text()},s={cameraBeta:.95,useFixedVelocity:!1,useNoTimeDelay:!1,galilean:!1,simultaneityFrame:1,relativisticBeaming:!1,dopplerEffect:!1,timePulse:!1},l=()=>null!=sessionStorage.uiState?JSON.parse(sessionStorage.uiState):s;let o=l();const r=({attributeName:e,label:t,save:a})=>{const n=document.createElement("input");n.type="checkbox",n.checked=o[e],n.addEventListener("change",(t=>{const n=t.target;null!=n&&n instanceof HTMLInputElement&&(o[e]=!!n.checked,a())}));const i=document.createElement("label");return i.appendChild(n),i.append(t),{toggleLabel:i,toggle:n}},c=({el:e,id:t,options:a,onChange:n})=>{const i=a.map((({value:e})=>{const a=document.createElement("input");return a.name=t,a.type="radio",a.value=String(e),a})),s=e;for(let e=0;e<a.length;e++){const t=document.createElement("label");t.appendChild(i[e]),t.append(a[e].label),s.append(t)}return null!=n&&i.forEach(((e,t)=>{const i=a[t].value;e.onclick=()=>{n(i)}})),{buttons:i,setValue:e=>{for(let t=0;t<a.length;t++){const{value:n}=a[t];i[t].checked=n===e}},setDisabled:e=>{for(let t=0;t<a.length;t++)i[t].disabled=e}}},d=()=>sessionStorage.relativityScene||"SubdividedCube.gltf";class p extends n.xcu{constructor(e,t,a){super(e,t,a),this.velocity=n.Pa4.Zero(),this.properVelocity=n.Pa4.Zero(),this.properAcceleration=n.Pa4.Zero(),this.dt=0,this.onAfterCheckInputsObservable.add(((e,t)=>{let a=this.dt;this.properAcceleration.copyFrom(this.cameraDirection);const n=this.dragCoefficient??0,i=this.properVelocity.normalizeToNew().scale(n*this.speed*this.inertia*Math.sqrt(this.properVelocity.length()));this.properAcceleration.subtractInPlace(i),this.properVelocity.addInPlace(this.properAcceleration.scale(a));let s=this.properVelocity.lengthSquared();null!=this.maxProperSpeed2&&s>this.maxProperSpeed2&&(this.properVelocity.normalize().scaleInPlace(Math.sqrt(this.maxProperSpeed2)),s=this.maxProperSpeed2);const l=1/Math.sqrt(1+s);this.properVelocity.scaleToRef(l,this.velocity),this.position.addInPlace(this.velocity.scale(a))}))}setMaxSpeed(e){if(null==e)return this.maxProperSpeed2=void 0,void(this.dragCoefficient=0);this.speed=e;const t=e*e,a=t<1?1/(1-t):1e4;this.maxProperSpeed2=a*t,this.dragCoefficient=1/Math.pow(this.maxProperSpeed2,1/4)}_computeLocalCameraSpeed(){return this.speed}_checkInputs(){var e=this.getEngine();this.dt=Math.sqrt(e.getDeltaTime()/(100*e.getFps())),this.dt>.1&&(this.dt=.1),this.cameraDirection.setAll(0),this.cameraRotation.scaleInPlace(Math.exp(-this.dt)*this.inertia),super._checkInputs()}_updatePosition(){}}const u=()=>(new Date).getTime(),m=u(),h=()=>{const{galilean:e,simultaneityFrame:t,useFixedVelocity:a,useNoTimeDelay:n,relativisticBeaming:i,dopplerEffect:s,timePulse:o}=l();return[e?"#define GALILEAN":"",n?0==t?"#define SIMULTANEITY_FRAME_WORLD":"#define SIMULTANEITY_FRAME_CAMERA":"",a?"#define FIXED_VELOCITY":"",n?"#define NO_TIME_DELAY":"",i?"#define RELATIVISTIC_BEAMING":"",s?"#define DOPPLER_EFFECT":"",o?"#define TIME_PULSE":""]},g=(e,t)=>{null!=t.int&&Object.entries(t.int).forEach((([t,a])=>{e.setInt(t,a)})),null!=t.vec3&&Object.entries(t.vec3).forEach((([t,a])=>{e.setVector3(t,a)})),null!=t.float&&Object.entries(t.float).forEach((([t,a])=>{e.setFloat(t,a)}))},f=(e,t,a,i,s)=>{const l={},o=[...s];a instanceof n.YVB?(null!=a.albedoTexture&&(l.albedoSampler=a.albedoTexture,o.push("#define ALBEDO_ENABLED")),null!=a.bumpTexture&&(l.bumpSampler=a.bumpTexture,o.push("#define TANGENT")),null!=a.metallicTexture&&(l.metallicRoughnessSampler=a.metallicTexture,o.push("#define METALLIC_ROUGHNESS_ENABLED"))):a instanceof n.Iij&&(null!=a.reflectionTexture&&(l.reflectionSampler=a.reflectionTexture),o.push("#define SKYBOX")),l.rgbMapSampler=t;const r=new n.jyz("shader"+i.name,e,{vertex:"custom",fragment:"custom"},{attributes:["position","normal","tangent","uv"],uniforms:["world","finalWorld","view","projection","velocity","time","metallicFactor","roughnessFactor"],samplers:Object.keys(l),defines:o});Object.entries(l).map((([e,t])=>{r.setTexture(e,t)})),((e,t)=>{const a={float:{},int:{},vec3:{}};e instanceof n.YVB&&(a.float.metallicFactor=e.metallic??1,a.float.roughnessFactor=e.roughness??1),g(t,a)})(a,r),i.material instanceof n.jyz&&i.material.dispose(),i.material=r};(async({el:e,sceneFilename:t})=>{const a=(e=>{const t=document.createElement("canvas");return t.style.position="absolute",t.width=e.clientWidth,t.height=e.clientHeight,t.style.position="fixed",t.tabIndex=0,window.addEventListener("resize",(a=>{t.width=e.clientWidth,t.height=e.clientHeight})),e.appendChild(t),t})(e),s=(e=>{const t=document.createElement("div");return t.classList.add("speed-indicator"),e.appendChild(t),t})(e),[b,v]=await Promise.all([i("main.vert"),i("main.frag")]),y=new n.D4V(a,!0);n.Qmf.ShadersStore.customVertexShader=b,n.Qmf.ShadersStore.customFragmentShader=v;const E=await n.n0n.LoadAsync(t),S=E.getNodeByID("Camera"),x=S?.position||new n.Pa4(0,.33,-9),C=S?.rotationQuaternion,T=((e,t,a)=>{const n=new p("camera1",t,a);return(e=>{e.keysDownward.push(81),e.keysDown.push(83),e.keysUpward.push(69),e.keysUp.push(87),e.keysLeft.push(65),e.keysRight.push(68),e.gamepadAngularSensibility=100,(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/iPhone/i))&&e.inputs.addVirtualJoystick(),e.speed=1,e.inertia=.9,e.minZ=.1,e.maxZ=1e4,e.fov=.9})(n),n})(0,x,E);null!=C?(T.rotationQuaternion=C,T.update()):T.setTarget(n.Pa4.Zero()),T.attachControl(!0);const L=new n.xEZ("./lambda_rgb_map.png",E,!1,void 0,n.xEZ.BILINEAR_SAMPLINGMODE);E.skipFrustumClipping=!0,(async e=>{const t=new n.BtG("skybox/skybox",e,["_px.png","_py.png","_pz.png","_nx.png","_ny.png","_nz.png"]);t.coordinatesMode=n.xEZ.SKYBOX_MODE,e.createDefaultEnvironment({environmentTexture:t,createGround:!1,skyboxSize:1e3,groundSize:1e3,skyboxTexture:t})})(E);const{definesChange:w,uniformsChange:N}=(({scene:e,rgbMapTexture:t})=>{const a=e.meshes.filter((e=>!(e instanceof n.SPe)&&null!=e.material)),i=a.map((e=>e.material));return{definesChange:n=>{for(let s=0;s<i.length;s++){const l=i[s],o=a[s];f(e,t,l,o,n)}},uniformsChange:e=>{for(let t=0;t<i.length;t++){const s=a[t],l=(i[t],s.material);l instanceof n.jyz&&g(l,e)}}}})({scene:E,rgbMapTexture:L});(({el:e,onStateChange:t})=>{o=l();const a=()=>{sessionStorage.uiState=JSON.stringify(o),t&&t(o)},n=(()=>{const e=document.createElement("input");return e.type="number",e.min="0",e.max="1",e.step="0.005",e.inputMode="decimal",e.value=o.cameraBeta?.toString(),e.title="Camera speed as a fraction of the speed of light.",e})();n.addEventListener("change",(e=>{const n=e.target;if(null==n||!(n instanceof HTMLInputElement))return;const i=parseFloat(n.value);Number.isNaN(i)||(o.cameraBeta=i,a(),t&&t(l()))}));const{toggleLabel:i}=r({attributeName:"useFixedVelocity",label:"Assume fixed camera speed",save:a}),{toggleLabel:s}=r({attributeName:"galilean",label:"Use Galilean relativity",save:a}),{toggleLabel:p}=r({attributeName:"relativisticBeaming",label:"Relativistic beaming",save:a}),{toggleLabel:u}=r({attributeName:"dopplerEffect",label:"Doppler effect",save:a}),{toggleLabel:m}=r({attributeName:"timePulse",label:"Show synchronization",save:a}),h=document.createElement("label");h.appendChild(n),h.append("Max camera speed (fraction of c)");const g=(e=>{const t=document.createElement("div"),{toggle:a,toggleLabel:n}=r({attributeName:"useNoTimeDelay",label:"Assume no light travel time in frame:",save:e});a.addEventListener("change",(e=>{const t=e.target;if(null==t||!(t instanceof HTMLInputElement))return;const a=!!t.checked;s(!a)})),t.appendChild(n);const{setValue:i,setDisabled:s}=c({el:t,id:"simultaneity-frame",options:[{label:"Camera",value:1},{label:"World",value:0}],onChange:t=>{o.simultaneityFrame=t,e()}});return i(o.simultaneityFrame),s(!o.useNoTimeDelay),t})(a),f=(()=>{const e=document.createElement("div"),t=document.createElement("label");t.append("Scene:"),e.appendChild(t);const{setValue:a}=c({el:e,id:"scene-picker",options:[{label:"Dice",value:"SubdividedCube.gltf"},{label:"Sponza",value:"https://specialrelativitymeshes.z5.web.core.windows.net/Sponza/sponza.gltf"}],onChange:e=>{sessionStorage.relativityScene=e,window.location.reload()}});return a(d()),e})(),b=document.createElement("details");b.className="main-ui";const v=document.createElement("summary");v.innerText="Help / Settings",b.appendChild(v);const y=document.createElement("div");y.innerText="Use WASD and mouse to move or touch on smartphone.",b.appendChild(y),b.appendChild(h),b.appendChild(p),b.appendChild(u),b.appendChild(g),b.appendChild(m),b.appendChild(s),b.appendChild(i),b.appendChild(f),e.appendChild(b)})({el:e,onStateChange:()=>{w(h())}}),w(h()),y.runRenderLoop((function(){const{cameraBeta:e}=l();T.setMaxSpeed(e);const t=(e=>{const{cameraBeta:t,galilean:a,simultaneityFrame:i,useFixedVelocity:s,useNoTimeDelay:o,relativisticBeaming:r,dopplerEffect:c,timePulse:d}=l(),p=null==e.velocity||s?e.getDirection(n.Pa4.Forward()).scale(t):e.velocity,h=p.length(),g=a?1:1/Math.sqrt(1-h*h);return{vec3:{velocity:p},float:{time:(u()-m)/1e3,gamma:g},int:{useNoTimeDelay:o?1:0,simultaneityFrame:i,useGalilean:a?1:0,relativisticBeaming:r?1:0,dopplerEffect:c?1:0,timePulse:d?1:0}}})(T);N(t);const a=t.vec3.velocity.length(),i=t.float.gamma;s.innerHTML=[`Speed: ${a.toFixed(3)}c`,`Gamma: ${i.toFixed(3)}`].join("<br/>"),E.render()})),window.addEventListener("resize",(function(){y.resize()})),a.focus()})({el:document.body,sceneFilename:d()}).catch(console.error)}}]);
//# sourceMappingURL=31.bootstrap.js.map