{"version":3,"file":"382.bootstrap.js","mappings":"0JAAO,MCCMA,EAAWC,MAAOC,IAC7B,MAAMC,QAAaC,MAAMF,GACzB,IAAKC,EAAKE,GACR,MAAM,IAAIC,MAAMH,EAAKI,YAEvB,OAAOJ,EAAKK,QCyBRC,EAAU,YAYVC,EAA0B,CAC9BC,WAAY,IACZC,kBAAkB,EAClBC,gBAAgB,EAChBC,UAAU,EACVC,kBAAmB,EACnBC,qBAAqB,EACrBC,eAAe,EACfC,WAAW,GAGAC,EAAW,IACW,MAA1BC,eAAeC,QAClBC,KAAKC,MAAMH,eAAeC,SAC1BX,EAGN,IAAIW,EAAmBF,IAEvB,MAyBMK,EAAe,EAAGC,cAAAA,EAAeC,MAAAA,EAAOC,KAAAA,MAC5C,MAAMC,EAASC,SAASC,cAAc,SACtCF,EAAOG,KAAO,WACdH,EAAOI,QAAUX,EAAQI,GACzBG,EAAOK,iBAAiB,UAAWC,IACjC,MAAMC,EAASD,EAAEC,OACH,MAAVA,GAAoBA,aAAkBC,mBAG1Cf,EAAQI,KAAmBU,EAAOH,QAClCL,QAEF,MAAMU,EAAcR,SAASC,cAAc,SAG3C,OAFAO,EAAYC,YAAYV,GACxBS,EAAYE,OAAOb,GACZ,CACLW,YAAAA,EACAT,OAAAA,IAgBEY,EAAoB,EAAMC,GAAAA,EAAIC,GAAAA,EAAIC,QAAAA,EAASC,SAAAA,MAC/C,MAAMC,EAAUF,EAAQG,KAAI,EAAGC,MAAAA,MAC7B,MAAMC,EAASnB,SAASC,cAAc,SAItC,OAHAkB,EAAOC,KAAOP,EACdM,EAAOjB,KAAO,QACdiB,EAAOD,MAAQG,OAAOH,GACfC,KAGHG,EAAcV,EACpB,IAAK,IAAIW,EAAM,EAAGA,EAAMT,EAAQU,OAAQD,IAAO,CAC7C,MAAME,EAAUzB,SAASC,cAAc,SACvCwB,EAAQhB,YAAYO,EAAQO,IAC5BE,EAAQf,OAAOI,EAAQS,GAAK1B,OAC5ByB,EAAYZ,OAAOe,GA0BrB,OARY,MAAZV,GACEC,EAAQU,SAAQ,CAACP,EAAQI,KACvB,MAAML,EAAQJ,EAAQS,GAAKL,MAC3BC,EAAOQ,QAAU,KACfZ,EAASG,OAIR,CACLF,QAAAA,EACAY,SAzBgBV,IAChB,IAAK,IAAIK,EAAM,EAAGA,EAAMT,EAAQU,OAAQD,IAAO,CAC7C,MAAQL,MAAOW,GAAgBf,EAAQS,GACxBP,EAAQO,GAChBpB,QAAU0B,IAAgBX,IAsBnCY,YAlBmBC,IACnB,IAAK,IAAIR,EAAM,EAAGA,EAAMT,EAAQU,OAAQD,IACvBP,EAAQO,GAChBQ,SAAWA,KA0DXC,EAAc,IAClBzC,eAAe0C,iBAAmBrD,EC1L3C,MAAMsD,UAAoC,MACxCC,SACAC,eACAC,mBACAC,GAEAC,gBACAC,gBAEOC,YAAYC,GACjB,GAAa,MAATA,EAGF,OAFAC,KAAKJ,qBAAkBK,OACvBD,KAAKH,gBAAkB,GAGzBG,KAAKD,MAAQA,EACb,MAAMG,EAAYH,EAAQA,EACpBI,EAASD,EAAY,EAAI,GAAK,EAAIA,GAAa,IACrDF,KAAKJ,gBAAkBO,EAASD,EAChCF,KAAKH,gBAAkB,EAAIO,KAAKC,IAAIL,KAAKJ,gBAAiB,EAAI,GAGhEU,YAAY7B,EAAc8B,EAAmBC,GAC3CC,MAAMhC,EAAM8B,EAAUC,GACtBR,KAAKR,SAAW,aAChBQ,KAAKP,eAAiB,aACtBO,KAAKN,mBAAqB,aAC1BM,KAAKL,GAAK,EAEVK,KAAKU,6BAA6BC,KAAI,CAACC,EAASC,KAC9C,IAAIlB,EAAKK,KAAKL,GAEdK,KAAKN,mBAAmBoB,SAASd,KAAKe,iBACtC,MAAMlB,EAAkBG,KAAKH,iBAAmB,EAK1CmB,EAAOhB,KAAKP,eACfwB,iBACAC,MACCrB,EACEG,KAAKD,MACLC,KAAKmB,QACLf,KAAKgB,KAAKpB,KAAKP,eAAeZ,WAEpCmB,KAAKN,mBAAmB2B,gBAAgBL,GAGxChB,KAAKP,eAAe6B,WAAWtB,KAAKN,mBAAmBwB,MAAMvB,IAE7D,IAAI4B,EAAevB,KAAKP,eAAe+B,gBAEX,MAAxBxB,KAAKJ,iBAA2B2B,EAAevB,KAAKJ,kBACtDI,KAAKP,eACFgC,YACAC,aAAatB,KAAKgB,KAAKpB,KAAKJ,kBAC/B2B,EAAevB,KAAKJ,iBAEtB,MAAM+B,EAAW,EAAIvB,KAAKgB,KAAK,EAAIG,GACnCvB,KAAKP,eAAemC,WAAWD,EAAU3B,KAAKR,UAC9CQ,KAAKO,SAASe,WAAWtB,KAAKP,eAAeyB,MAAMvB,IAQnD,MAAMkC,EAAMrB,EAAMsB,gBACdD,EAAIhD,OAAS,IACfgD,EAAI,GAAGE,WAAa,IAAMJ,MAKzBK,2BACL,OAAOhC,KAAKD,MAGPkC,eACL,IAAIC,EAASlC,KAAKmC,YAGlBnC,KAAKL,GAAKS,KAAKgB,KAAKc,EAAOE,gBAAoC,IAAlBF,EAAOG,WAEhDrC,KAAKL,GAAK,KACZK,KAAKL,GAAK,IAGZK,KAAKe,gBAAgBuB,OAAO,GAE5BtC,KAAKuC,eAAeb,aAAatB,KAAKoC,KAAKxC,KAAKL,IAAMK,KAAKmB,SAE3DV,MAAMwB,eAIDQ,oBAOT,MCpHMC,EAAQ,KACL,IAAIC,MAAOC,UAGdC,EAAQH,IAEDI,EAAqB,KAChC,MAAM,SACJxG,EAAQ,kBACRC,EAAiB,iBACjBH,EAAgB,eAChBC,EAAc,oBACdG,EAAmB,cACnBC,EAAa,UACbC,GACEC,IAcJ,MAbgB,CACdL,EAAW,mBAAqB,GAChCD,EACyB,GAArBE,EACE,mCACA,oCACF,GACJH,EAAmB,yBAA2B,GAC9CC,EAAiB,wBAA0B,GAC3CG,EAAsB,+BAAiC,GACvDC,EAAgB,yBAA2B,GAC3CC,EAAY,qBAAuB,KAoD1BqG,EAAc,CAACC,EAAwBC,KAClC,MAAZA,EAAKC,KACPC,OAAOC,QAAQH,EAAKC,KAAKnE,SAAQ,EAAEsE,EAAaC,MAC9CN,EAAOO,OAAOF,EAAaC,MAGd,MAAbL,EAAKO,MACPL,OAAOC,QAAQH,EAAKO,MAAMzE,SAAQ,EAAEsE,EAAaC,MAC/CN,EAAOS,WAAWJ,EAAaC,MAGjB,MAAdL,EAAKS,OACPP,OAAOC,QAAQH,EAAKS,OAAO3E,SAAQ,EAAEsE,EAAaC,MAChDN,EAAOW,SAASN,EAAaC,OCzB7BM,EAAuB,CAC3BpD,EACAqD,EACAC,EACAC,EACAC,KAEA,MAAMC,EAAwC,GACxCC,EAAU,IAAIF,GAChBF,aAAoB,OAEQ,MAA1BA,EAASK,gBACXF,EAAwB,cAAIH,EAASK,cACrCD,EAAQE,KAAK,2BAEa,MAAxBN,EAASO,cACXJ,EAAsB,YAAIH,EAASO,YACnCH,EAAQE,KAAK,wBACTL,EAAKO,sBAAsB,oBAC7BJ,EAAQE,KAAK,oBAGe,MAA5BN,EAASS,kBACXN,EAAmC,yBAAIH,EAASS,gBAChDL,EAAQE,KAAK,wCAENN,aAAoB,QACK,MAA9BA,EAASU,oBACXP,EAA4B,kBAAIH,EAASU,mBAE3CN,EAAQE,KAAK,mBAEfH,EAAwB,cAAIJ,EAC5B,MAAMY,EAAiB,IAAI,MACzB,SAAWV,EAAKtF,KAChB+B,EACA,CACEkE,OAAQ,SACRC,SAAU,UAEZ,CACEC,WAAY,CAAC,WAAY,SAAU,UAAW,MAC9CC,SAAU,CACR,QACA,aACA,OACA,aACA,WACA,OACA,WACA,iBACA,kBACA,iBACA,kBAEFZ,SAAUd,OAAO2B,KAAKb,GACtBC,QAAAA,IAGJf,OAAOC,QAAQa,GAAU3F,KAAI,EAAEG,EAAMsG,MACnCN,EAAeO,WAAWvG,EAAMsG,MAzEP,EAACjB,EAAoBd,KAChD,MAAMiC,EAA+B,CACnCvB,MAAO,GACPR,IAAK,GACLM,KAAM,IAEJM,aAAoB,QACtBmB,EAAcvB,MAAuB,eAAII,EAASoB,UAAY,EAC9DD,EAAcvB,MAAwB,gBAAII,EAASqB,WAAa,GAElEpC,EAAYC,EAAQiC,IAiEpBG,CAAqBtB,EAAUW,GAE3BV,EAAKD,oBAAoB,OAC3BC,EAAKD,SAASuB,UAEhBtB,EAAKD,SAAWW,GC1HLhJ,QAASwC,GAAAA,EAAIqH,cAAAA,MACxB,MAAMC,ENvBoB,CAACtH,IAC3B,MAAMsH,EAASlI,SAASC,cAAc,UAatC,OAZAiI,EAAOC,MAAMjF,SAAW,WACxBgF,EAAOE,MAAQxH,EAAGyH,YAClBH,EAAOI,OAAS1H,EAAG2H,aACnBL,EAAOC,MAAMjF,SAAW,QACxBgF,EAAOM,SAAW,EAElBC,OAAOrI,iBAAiB,UAAUsI,IAChCR,EAAOE,MAAQxH,EAAGyH,YAClBH,EAAOI,OAAS1H,EAAG2H,gBAGrB3H,EAAGH,YAAYyH,GACRA,GMSQS,CAAa/H,GAEtBgI,EJqN0B,CAAChI,IACjC,MAAMgI,EAAiB5I,SAASC,cAAc,OAG9C,OAFA2I,EAAeC,UAAUvF,IAAI,mBAC7B1C,EAAGH,YAAYmI,GACRA,GIzNgBE,CAAmBlI,IAEnCmI,EAAcC,SAAwBC,QAAQC,IAAI,CACvD/K,EAAS,aACTA,EAAS,eAGL0G,EAAS,IAAI,MAAOqD,GAAQ,GAElC,sCAA4Ca,EAE5C,wCAA8CC,EAE9C,MAAM7F,QAAc,gBAAsB8E,GAEpCkB,GAAqBhG,EAAMiG,QAAU,IAAIC,QAC5CC,GAAUA,aAAiB,QAE9B,GAAiC,IAA7BH,EAAkB3H,OAAc,CAClC,MAAM0B,EAAW,IAAI,MAAQ,GAAI,EAAG,GAC9BoG,EAAQ,IAAI,MAAiB,YAAapG,EAAUC,GAC1DmG,EAAMC,UAAY,GAClBJ,EAAkBpC,KAAKuC,GAEzB,MAAMA,EAAQH,EAAkB,GAG1BK,EACJrG,EAAMsG,SAAWtG,EAAMsG,QAAQjI,OAAS,EAAI2B,EAAMsG,QAAQ,QAAK7G,EAC3D8G,EACJF,GAAmBG,gBAAkB,IAAI,MAAQ,EAAG,EAAG,GACnDC,EAAkBJ,GAAmBK,iBAClB,MAArBL,GACFrG,EAAM2G,aAAaN,GAErB,MAAMO,EHoGoB,EAC1B3I,EACA8B,EACAC,KAEA,MAAM4G,EAAS,IAAI7H,EGzGS,UHyGyBgB,EAAUC,GAE/D,MA3BiB,CAAC4G,IAElBA,EAAOC,aAAajD,KANN,IAOdgD,EAAOE,SAASlD,KATE,IAUlBgD,EAAOG,WAAWnD,KATN,IAUZgD,EAAOI,OAAOpD,KAZG,IAajBgD,EAAOK,SAASrD,KARF,IASdgD,EAAOM,UAAUtD,KAVF,IAWfgD,EAAOO,0BAA4B,KApBjCC,UAAUC,UAAUC,MAAM,aAC1BF,UAAUC,UAAUC,MAAM,aAqB1BV,EAAOW,OAAOC,qBAGhBZ,EAAOrH,MAAQ,EACfqH,EAAOjG,QAAU,GACjBiG,EAAOa,KAAO,GACdb,EAAOc,KAAO,IACdd,EAAOe,IAAM,IASbC,CAAWhB,GACJA,GG3GQiB,CAAa,EAAWtB,EAAiBvG,GACxDA,EAAM8H,aAAelB,EAEE,MAAnBH,GACFG,EAAOmB,mBAAqBtB,EAG5BG,EAAOoB,UAAUpB,EAAOqB,iBAAiB,KAEzCrB,EAAOoB,UAAU,cAGnBpB,EAAOsB,eAAc,GAErB,MAAM7E,EAAgB,IAAI,MACxB,uBACArD,GACA,OACAP,EACA,6BAKFO,EAAMmI,qBAAsB,OClFJlN,OAAO+E,IAC/B,MAAMoI,EAAc,IAAI,MACtB,yBACApI,EACA,MAGFoI,EAAYC,gBAAkB,kBAC9BrI,EAAMsI,yBAAyB,CAC7BC,cAAc,EACdC,WAAY,IACZC,WAAY,IACZC,cAAeN,KDuEXO,CAAW3I,GAEjB,MAAM,cAAE4I,EAAa,eAAEC,GDnEE,GAAG7I,MAAAA,EAAOqD,cAAAA,MACnC,MAAMyF,EAAc9I,EAAM+I,OAAO7C,QAC9B3C,KAAWA,aAAgB,QAAmC,MAAjBA,EAAKD,WAE/C0F,EAAYF,EAAYhL,KAAKyF,GAASA,EAAKD,WAkCjD,MAAO,CACLsF,cAlCqBlF,IACrB,IAAK,IAAIuF,EAAI,EAAGA,EAAID,EAAU3K,OAAQ4K,IAAK,CACzC,MAAM3F,EAAW0F,EAAUC,GACrB1F,EAAOuF,EAAYG,GACzB7F,EAAqBpD,EAAOqD,EAAeC,EAAWC,EAAMG,KA+B9DmF,eA5BsBxE,IACtB,IAAK,IAAI4E,EAAI,EAAGA,EAAID,EAAU3K,OAAQ4K,IAAK,CACzC,MAAM1F,EAAOuF,EAAYG,GAEnBhF,GADW+E,EAAUC,GACJ1F,EAAKD,UAI5B,GAA0B,UAAtBC,EAAK2F,QAAQjL,KAAkB,CACjC,MAAMkL,EAAK9E,EAASrB,MAAiB,SACrC,GAAU,MAANmG,EAAY,CACd,MAAMC,EAAK,IAAI,MAAQ,EAAG,GAAI,KAC9B/E,EAASrB,KAAsB,eAAIoG,QAGrC/E,EAASrB,KAAsB,eAAI,aAE/BiB,aAA0B,OAGhC1B,EAAY0B,EAAgBI,OCmCUgF,CAAY,CACpDrJ,MAAAA,EACAqD,cAAAA,IJkKkB,GAAG5F,GAAAA,EAAI6L,cAAAA,MAC3BjN,EAAUF,IACV,MAAMQ,EAAO,KArNbP,eAAeC,QAAUC,KAAKiN,UAAUlN,GAuNtCiN,GAAiBA,EAAcjN,IAG3BmN,EApMkB,MACxB,MAAMA,EAAS3M,SAASC,cAAc,SAQtC,OAPA0M,EAAOzM,KAAO,SACdyM,EAAOC,IAAM,IACbD,EAAOE,IAAM,IACbF,EAAOG,KAAO,QACdH,EAAOI,UAAY,UACnBJ,EAAOzL,MAAQ1B,EAAQV,YAAYkO,WACnCL,EAAOM,MAAQ,oDACRN,GA2LQO,GACfP,EAAOvM,iBAAiB,UAAWC,IACjC,MAAMC,EAASD,EAAEC,OACjB,GAAc,MAAVA,KAAoBA,aAAkBC,kBACxC,OAEF,MAAM4M,EAAYC,WAAW9M,EAAOY,OAC/BmM,OAAOC,MAAMH,KAChB3N,EAAQV,WAAaqO,EACrBrN,IACA2M,GAAiBA,EAAcnN,SAInC,MAAQkB,YAAa+M,GAA0B5N,EAAa,CAC1DC,cAAe,mBACfC,MAAO,4BACPC,KAAAA,KAGMU,YAAagN,GAAwB7N,EAAa,CACxDC,cAAe,WACfC,MAAO,yCACPC,KAAAA,KAGMU,YAAaiN,GAAmC9N,EAAa,CACnEC,cAAe,sBACfC,MAAO,uBACPC,KAAAA,KAGMU,YAAakN,GAA6B/N,EAAa,CAC7DC,cAAe,gBACfC,MAAO,iBACPC,KAAAA,KAGMU,YAAamN,GAAyBhO,EAAa,CACzDC,cAAe,YACfC,MAAO,sCACPC,KAAAA,IAGI8N,EAAc5N,SAASC,cAAc,SAC3C2N,EAAYnN,YAAYkM,GACxBiB,EAAYlN,OAAO,oCAEnB,MAAMmN,EA3IyB,CAACC,IAChC,MAAMxM,EAActB,SAASC,cAAc,QACrC,OAAEF,EAAM,YAAES,GAAgBb,EAAa,CAC3CC,cAAe,iBACfC,MAAO,wCACPC,KAAMgO,IAER/N,EAAOK,iBAAiB,UAAWC,IACjC,MAAMC,EAASD,EAAEC,OACjB,GAAc,MAAVA,KAAoBA,aAAkBC,kBACxC,OAEF,MAAMvB,IAAmBsB,EAAOH,QAChC2B,GAAa9C,MAEfsC,EAAYb,YAAYD,GACxB,MAAM,SAAEoB,EAAQ,YAAEE,GAAgBnB,EAAkB,CAClDC,GAAIU,EACJT,GAAI,qBACJC,QAAS,CACP,CACEjB,MAAO,SACPqB,MAAO,GAET,CACErB,MAAO,QACPqB,MAAO,IAGXH,SAAWG,IACT1B,EAAQN,kBAAoBgC,EAC5B4M,OAKJ,OAFAlM,EAASpC,EAAQN,mBACjB4C,GAAatC,EAAQR,gBACdsC,GAuGoByM,CAAyBjO,GAC9CkO,EAjGkB,MACxB,MAAM1M,EAActB,SAASC,cAAc,OACrCJ,EAAQG,SAASC,cAAc,SACrCJ,EAAMa,OAAO,UACbY,EAAYb,YAAYZ,GACxB,MAAM,SAAE+B,GAAajB,EAA0B,CAC7CC,GAAIU,EACJT,GAAI,eACJC,QAAS,CACP,CACEjB,MAAO,OACPqB,MAAOtC,GAET,CACEiB,MAAO,SACPqB,MAhMN,+EAmMEH,SAAWG,IACT3B,eAAe0C,gBAAkBf,EAEjCuH,OAAOwF,SAASC,YAIpB,OADAtM,EAASI,KACFV,GAwEa6M,GAEdC,EAAOpO,SAASC,cAAc,WACpCmO,EAAKC,UAAY,UACjB,MAAMC,EAAYtO,SAASC,cAAc,WACzCqO,EAAUC,UAAY,kBACtBH,EAAK3N,YAAY6N,GAEjB,MAAME,EAAWxO,SAASC,cAAc,OACxCuO,EAASD,UAAY,qDACrBH,EAAK3N,YAAY+N,GACjBJ,EAAK3N,YAAYmN,GACjBQ,EAAK3N,YAAYgN,GACjBW,EAAK3N,YAAYiN,GACjBU,EAAK3N,YAAYoN,GACjBO,EAAK3N,YAAYkN,GACjBS,EAAK3N,YAAY+M,GACjBY,EAAK3N,YAAY8M,GACjBa,EAAK3N,YAAYuN,GACjBpN,EAAGH,YAAY2N,II1OfK,CAAO,CACL7N,GAAAA,EACA6L,cAAe,KACbV,EAActG,QAIlBZ,EAAO6J,uBAAuBC,SAAQ,KAEpC5C,EAActG,QAIhBZ,EAAO+J,eAAc,WACnB,MAAM,WAAE9P,GAAeQ,IAEvByK,EAAOtH,YAAY3D,GACnB,MAAM8I,EFhEsB,EAC9BmC,EACAT,KAEA,MAAM,WACJxK,EAAU,SACVG,EAAQ,kBACRC,EAAiB,iBACjBH,EAAgB,eAChBC,EAAc,oBACdG,EAAmB,cACnBC,EAAa,UACbC,GACEC,IACE6C,EACe,MAAnB4H,EAAO5H,UAAoBpD,EACvBgL,EAAO8E,aAAa,iBAAmBhL,MAAM/E,GAC7CiL,EAAO5H,SACPO,EAAQP,EAASX,SACjBsN,EAAQ7P,EAAW,EAAI,EAAI8D,KAAKgB,KAAK,EAAIrB,EAAQA,GACvD4G,EAAMyF,gCACN,MAAMC,EAAW1F,EAAM2F,sBAAwB3F,EAAM4F,UAErD,OADAF,GAAYA,EAAS5K,YACd,CACL+B,KAAM,CACJhE,SAAAA,EACA6M,SAAAA,GAEF3I,MAAO,CACL8I,MAAO9J,IAAUG,GAAS,IAC1BsJ,MAAAA,GAEFjJ,IAAK,CACH7G,eAAgBA,EAAiB,EAAI,EACrCE,kBAAAA,EACAkQ,YAAanQ,EAAW,EAAI,EAC5BE,oBAAqBA,EAAsB,EAAI,EAC/CC,cAAeA,EAAgB,EAAI,EACnCC,UAAWA,EAAY,EAAI,KE0BPgQ,CAAiBtF,EAAQT,GAC/C0C,EAAepE,GAEf,MAAMlF,EAAQkF,EAAczB,KAAKhE,SAASX,SACpCsN,EAAQlH,EAAcvB,MAAMyI,MAElClG,EAAe0G,UAAY,CACzB,UAAU5M,EAAM6M,QAAQ,MACxB,UAAUT,EAAMS,QAAQ,MACxBC,KAAK,SACPrM,EAAMsM,YAIRhH,OAAOrI,iBAAiB,UAAU,WAChCyE,EAAO6K,YAETxH,EAAOyH,SAGTC,CAAK,CACHhP,GAAIZ,SAAS6P,KACb5H,cAAejG,MACd8N,MAAMC,QAAQC","sources":["webpack://hg-special-relativity/./src/canvas-utils.ts","webpack://hg-special-relativity/./src/load-text.ts","webpack://hg-special-relativity/./src/ui.ts","webpack://hg-special-relativity/./src/camera.ts","webpack://hg-special-relativity/./src/utils.ts","webpack://hg-special-relativity/./src/shaders.ts","webpack://hg-special-relativity/./src/index.ts","webpack://hg-special-relativity/./src/skybox.ts"],"sourcesContent":["export const createCanvas = (el: HTMLElement): HTMLCanvasElement => {\n  const canvas = document.createElement(\"canvas\");\n  canvas.style.position = \"absolute\";\n  canvas.width = el.clientWidth;\n  canvas.height = el.clientHeight;\n  canvas.style.position = \"fixed\";\n  canvas.tabIndex = 0;\n\n  window.addEventListener(\"resize\", _e => {\n    canvas.width = el.clientWidth;\n    canvas.height = el.clientHeight;\n  })\n\n  el.appendChild(canvas);\n  return canvas;\n};\n\n/**\n * Create and initialize the canvas and add to the DOM.\n *\n * @param el Element to add the canvas to.\n */\nexport const createGlContext = (\n  canvas: HTMLCanvasElement\n): WebGL2RenderingContext => {\n  const gl = canvas.getContext(\"webgl2\", {\n    antialias: true,\n  });\n\n  if (gl == null) {\n    throw new Error(\"Unable to create WebGL 2 context.\");\n  }\n\n  return gl;\n};\n","/** Load file as a string. */\nexport const loadText = async (url: string) => {\n  const resp = await fetch(url);\n  if (!resp.ok) {\n    throw new Error(resp.statusText);\n  }\n  return resp.text();\n};\n","export const enum SimultaneityFrame {\n  world = 0,\n  camera = 1,\n}\n\n/** UI configuration used in this demo. */\nexport type UiState = {\n  /** Fraction of the speed of light the camera is traveling at. */\n  cameraBeta: number;\n  /** Use a fixed velocity as the speed of light. */\n  useFixedVelocity: boolean;\n  /** Don't take into account travel time of light to reach camera. */\n  useNoTimeDelay: boolean;\n  /**\n   * True to transform according to Euclidean space. False for special\n   * relativity.\n   */\n  galilean: boolean;\n  /**\n   * Used with `useNoTimeDelay` to define which frame to use to define\n   * when events are simultaneous.\n   */\n  simultaneityFrame: SimultaneityFrame;\n  /** Set to true to enable relativistic beaming. */\n  relativisticBeaming: boolean;\n  /** Set to true to doppler shift the wavelength of light. */\n  dopplerEffect: boolean;\n  /** Set to true to show a time pulse. */\n  timePulse: boolean;\n};\n\nconst diceUrl = \"dice.gltf\";\nconst sponzaUrl =\n  \"https://specialrelativitymeshes.z5.web.core.windows.net/Sponza/sponza.gltf\";\n\n/**\n * Save the state to session storage, which is preserved until the browser is\n * closed.\n */\nconst saveState = () => {\n  sessionStorage.uiState = JSON.stringify(uiState);\n};\n\nconst defaultUiState: UiState = {\n  cameraBeta: 0.95,\n  useFixedVelocity: false,\n  useNoTimeDelay: false,\n  galilean: false,\n  simultaneityFrame: SimultaneityFrame.camera,\n  relativisticBeaming: false,\n  dopplerEffect: false,\n  timePulse: false,\n};\n\nexport const getState = (): UiState => {\n  return sessionStorage.uiState != null\n    ? JSON.parse(sessionStorage.uiState)\n    : defaultUiState;\n};\n\nlet uiState: UiState = getState();\n\nconst createSpeedSlider = () => {\n  const slider = document.createElement(\"input\");\n  slider.type = \"number\";\n  slider.min = \"0\";\n  slider.max = \"1\";\n  slider.step = \"0.005\";\n  slider.inputMode = \"decimal\";\n  slider.value = uiState.cameraBeta?.toString();\n  slider.title = \"Camera speed as a fraction of the speed of light.\";\n  return slider;\n};\n\ntype FilterPropertiesByType<T, U> = {\n  [K in keyof T as T[K] extends U ? K : never]: T[K];\n};\n\n/** UiState keys that are booleans. */\ntype BooleanUiKeys = keyof FilterPropertiesByType<UiState, boolean>;\n\ntype ToggleProps = {\n  attributeName: BooleanUiKeys;\n  label: string;\n  save: () => void;\n};\n\nconst createToggle = ({ attributeName, label, save }: ToggleProps) => {\n  const toggle = document.createElement(\"input\");\n  toggle.type = \"checkbox\";\n  toggle.checked = uiState[attributeName];\n  toggle.addEventListener(\"change\", (e) => {\n    const target = e.target;\n    if (target == null || !(target instanceof HTMLInputElement)) {\n      return;\n    }\n    uiState[attributeName] = !!target.checked;\n    save();\n  });\n  const toggleLabel = document.createElement(\"label\");\n  toggleLabel.appendChild(toggle);\n  toggleLabel.append(label);\n  return {\n    toggleLabel,\n    toggle,\n  };\n};\n\ntype PickerOption<T> = {\n  label: string;\n  value: T;\n};\n\ntype Picker<T> = {\n  el: HTMLElement;\n  id: string;\n  options: PickerOption<T>[];\n  onChange?: (value: T) => void;\n};\n\nconst createRadioPicker = <T>({ el, id, options, onChange }: Picker<T>) => {\n  const buttons = options.map(({ value }) => {\n    const button = document.createElement(\"input\");\n    button.name = id;\n    button.type = \"radio\";\n    button.value = String(value);\n    return button;\n  });\n\n  const containerEl = el;\n  for (let idx = 0; idx < options.length; idx++) {\n    const labelEl = document.createElement(\"label\");\n    labelEl.appendChild(buttons[idx]);\n    labelEl.append(options[idx].label);\n    containerEl.append(labelEl);\n  }\n\n  const setValue = (value: T) => {\n    for (let idx = 0; idx < options.length; idx++) {\n      const { value: buttonValue } = options[idx];\n      const button = buttons[idx];\n      button.checked = buttonValue === value;\n    }\n  };\n\n  const setDisabled = (disabled: boolean) => {\n    for (let idx = 0; idx < options.length; idx++) {\n      const button = buttons[idx];\n      button.disabled = disabled;\n    }\n  };\n\n  onChange != null &&\n    buttons.forEach((button, idx) => {\n      const value = options[idx].value;\n      button.onclick = () => {\n        onChange(value);\n      };\n    });\n\n  return {\n    buttons,\n    setValue,\n    setDisabled,\n  };\n};\n\nconst createSimultaneityPicker = (saveState: () => void) => {\n  const containerEl = document.createElement(\"div\");\n  const { toggle, toggleLabel } = createToggle({\n    attributeName: \"useNoTimeDelay\",\n    label: \"Assume no light travel time in frame:\",\n    save: saveState,\n  });\n  toggle.addEventListener(\"change\", (e) => {\n    const target = e.target;\n    if (target == null || !(target instanceof HTMLInputElement)) {\n      return;\n    }\n    const useNoTimeDelay = !!target.checked;\n    setDisabled(!useNoTimeDelay);\n  });\n  containerEl.appendChild(toggleLabel);\n  const { setValue, setDisabled } = createRadioPicker({\n    el: containerEl,\n    id: \"simultaneity-frame\",\n    options: [\n      {\n        label: \"Camera\",\n        value: SimultaneityFrame.camera,\n      },\n      {\n        label: \"World\",\n        value: SimultaneityFrame.world,\n      },\n    ],\n    onChange: (value) => {\n      uiState.simultaneityFrame = value;\n      saveState();\n    },\n  });\n  setValue(uiState.simultaneityFrame);\n  setDisabled(!uiState.useNoTimeDelay);\n  return containerEl;\n};\n\nexport const getSceneUrl = (): string => {\n  return sessionStorage.relativityScene || diceUrl;\n};\n\nconst createScenePicker = () => {\n  const containerEl = document.createElement(\"div\");\n  const label = document.createElement(\"label\");\n  label.append(\"Scene:\");\n  containerEl.appendChild(label);\n  const { setValue } = createRadioPicker<string>({\n    el: containerEl,\n    id: \"scene-picker\",\n    options: [\n      {\n        label: \"Dice\",\n        value: diceUrl,\n      },\n      {\n        label: \"Sponza\",\n        value: sponzaUrl,\n      },\n    ],\n    onChange: (value) => {\n      sessionStorage.relativityScene = value;\n      // Reload the browser for simplicity.\n      window.location.reload();\n    },\n  });\n  setValue(getSceneUrl());\n  return containerEl;\n};\n\nexport const initSpeedIndicator = (el: HTMLElement) => {\n  const speedIndicator = document.createElement(\"div\");\n  speedIndicator.classList.add(\"speed-indicator\");\n  el.appendChild(speedIndicator);\n  return speedIndicator;\n};\n\nexport type UiConfig = {\n  el: HTMLElement;\n  onStateChange?: (config: UiState) => void;\n};\n\n/** Element to add the UI to. */\nexport const initUi = ({ el, onStateChange }: UiConfig) => {\n  uiState = getState();\n  const save = () => {\n    saveState();\n    onStateChange && onStateChange(uiState);\n  };\n\n  const slider = createSpeedSlider();\n  slider.addEventListener(\"change\", (e) => {\n    const target = e.target;\n    if (target == null || !(target instanceof HTMLInputElement)) {\n      return;\n    }\n    const currValue = parseFloat(target.value);\n    if (!Number.isNaN(currValue)) {\n      uiState.cameraBeta = currValue;\n      save();\n      onStateChange && onStateChange(getState());\n    }\n  });\n\n  const { toggleLabel: fixedSpeedToggleLabel } = createToggle({\n    attributeName: \"useFixedVelocity\",\n    label: \"Assume fixed camera speed\",\n    save,\n  });\n\n  const { toggleLabel: galileanToggleLabel } = createToggle({\n    attributeName: \"galilean\",\n    label: \"Use Galilean relativity (Experimental)\",\n    save,\n  });\n\n  const { toggleLabel: relativisticBeamingToggleLabel } = createToggle({\n    attributeName: \"relativisticBeaming\",\n    label: \"Relativistic beaming\",\n    save,\n  });\n\n  const { toggleLabel: dopplerEffectToggleLabel } = createToggle({\n    attributeName: \"dopplerEffect\",\n    label: \"Doppler effect\",\n    save,\n  });\n\n  const { toggleLabel: timePulseToggleLabel } = createToggle({\n    attributeName: \"timePulse\",\n    label: \"Show synchronization (Experimental)\",\n    save,\n  });\n\n  const sliderLabel = document.createElement(\"label\");\n  sliderLabel.appendChild(slider);\n  sliderLabel.append(\"Max camera speed (fraction of c)\");\n\n  const simultaneityPicker = createSimultaneityPicker(save);\n  const scenePicker = createScenePicker();\n\n  const uiEl = document.createElement(\"details\");\n  uiEl.className = \"main-ui\";\n  const summaryEl = document.createElement(\"summary\");\n  summaryEl.innerText = \"Help / Settings\";\n  uiEl.appendChild(summaryEl);\n\n  const helptext = document.createElement(\"div\");\n  helptext.innerText = \"Use WASD and mouse to move or touch on smartphone.\";\n  uiEl.appendChild(helptext);\n  uiEl.appendChild(sliderLabel);\n  uiEl.appendChild(relativisticBeamingToggleLabel);\n  uiEl.appendChild(dopplerEffectToggleLabel);\n  uiEl.appendChild(simultaneityPicker);\n  uiEl.appendChild(timePulseToggleLabel);\n  uiEl.appendChild(galileanToggleLabel);\n  uiEl.appendChild(fixedSpeedToggleLabel);\n  uiEl.appendChild(scenePicker);\n  el.appendChild(uiEl);\n};\n","import {\n  Scene,\n  Vector3,\n  Epsilon,\n  UniversalCamera,\n  TargetCamera,\n} from \"@babylonjs/core\";\n\nexport interface RelativisticCamera extends TargetCamera {\n  velocity: Vector3;\n  properVelocity: Vector3;\n  /** Set the max (coordinate) speed. */\n  setMaxSpeed(speed: number | undefined): void;\n}\n\n/**\n * Modifications to the default camera to get smooth acceleration and\n * deceleration. This is necessary to get a smooth velocity.\n *\n * This could probably be replaced with a standard physics integrator.\n */\nclass RelativisticUniversalCamera extends UniversalCamera {\n  velocity: Vector3;\n  properVelocity: Vector3;\n  properAcceleration: Vector3;\n  dt: number;\n\n  maxProperSpeed2: number | undefined;\n  dragCoefficient: number | undefined;\n\n  public setMaxSpeed(speed: number | undefined) {\n    if (speed == null) {\n      this.maxProperSpeed2 = undefined;\n      this.dragCoefficient = 0;\n      return;\n    }\n    this.speed = speed;\n    const maxSpeed2 = speed * speed;\n    const gamma2 = maxSpeed2 < 1 ? 1 / (1 - maxSpeed2) : 10000;\n    this.maxProperSpeed2 = gamma2 * maxSpeed2;\n    this.dragCoefficient = 1 / Math.pow(this.maxProperSpeed2, 1 / 4);\n  }\n\n  constructor(name: string, position: Vector3, scene: Scene) {\n    super(name, position, scene);\n    this.velocity = Vector3.Zero();\n    this.properVelocity = Vector3.Zero();\n    this.properAcceleration = Vector3.Zero();\n    this.dt = 0;\n\n    this.onAfterCheckInputsObservable.add((_camera, _eventState) => {\n      let dt = this.dt;\n      // Apply acceleration with a drag term.\n      this.properAcceleration.copyFrom(this.cameraDirection);\n      const dragCoefficient = this.dragCoefficient ?? 0;\n      // Scaling the drag factor by the sqrt of the velocity is arbitrary\n      // and I just did it because it's cleaner. If you change it then\n      // you also need to change the drag coefficient. If below were\n      // pow(x, 1/3) then above would be `pow(maxProperSpeed, 1/2*1/3).\n      const drag = this.properVelocity\n        .normalizeToNew()\n        .scale(\n          dragCoefficient *\n            this.speed *\n            this.inertia *\n            Math.sqrt(this.properVelocity.length())\n        );\n      this.properAcceleration.subtractInPlace(drag);\n\n      // Euler integration step.\n      this.properVelocity.addInPlace(this.properAcceleration.scale(dt));\n      // Compute the normal velocity from the proper velocity.\n      let properSpeed2 = this.properVelocity.lengthSquared();\n      // If a max speed is set, then we should respect it.\n      if (this.maxProperSpeed2 != null && properSpeed2 > this.maxProperSpeed2) {\n        this.properVelocity\n          .normalize()\n          .scaleInPlace(Math.sqrt(this.maxProperSpeed2));\n        properSpeed2 = this.maxProperSpeed2;\n      }\n      const invGamma = 1 / Math.sqrt(1 + properSpeed2);\n      this.properVelocity.scaleToRef(invGamma, this.velocity);\n      this.position.addInPlace(this.properVelocity.scale(dt));\n\n      // Adjust animation speed to make it consistent\n      // with the camera speed, but first need to find\n      // out why the camera speed isn't consistent with\n      // this speed.\n      // Get rid of this if we implement moving objects\n      // manually without the GLTF animation.\n      const ags = scene.animationGroups;\n      if (ags.length > 0) {\n        ags[0].speedRatio = 3.1 / invGamma;\n      }\n    });\n  }\n\n  public _computeLocalCameraSpeed() {\n    return this.speed;\n  }\n\n  public _checkInputs() {\n    var engine = this.getEngine();\n    // This is taken from the Babylon JS code. Not sure why it's not just\n    // `getDeltaTime`.\n    this.dt = Math.sqrt(engine.getDeltaTime() / (engine.getFps() * 100.0));\n    // Don't allow the timestep to get too large, so clamp it.\n    if (this.dt > 0.1) {\n      this.dt = 0.1;\n    }\n    // Reset the camera direction.\n    this.cameraDirection.setAll(0);\n    // Smoothly stop rotation when rotation is stopped.\n    this.cameraRotation.scaleInPlace(Math.exp(-this.dt) * this.inertia);\n\n    super._checkInputs();\n  }\n\n  /** Don't allow the default position update. */\n  public _updatePosition() {}\n}\n\n/**\n * Not great check, but used to determine if we should use a virtual\n * joystick or wasd keyboard.\n */\nconst runningSmartphone = () => {\n  return (\n    navigator.userAgent.match(/Android/i) ||\n    navigator.userAgent.match(/iPhone/i)\n  );\n};\n\nconst keyForward = 87;\nconst keyBackward = 83;\nconst keyUp = 69;\nconst keyDown = 81;\nconst keyRight = 68;\nconst keyLeft = 65;\n\nconst initCamera = (camera: RelativisticUniversalCamera) => {\n  // Enable WASD keys for camera control.\n  camera.keysDownward.push(keyDown);\n  camera.keysDown.push(keyBackward);\n  camera.keysUpward.push(keyUp);\n  camera.keysUp.push(keyForward);\n  camera.keysLeft.push(keyLeft);\n  camera.keysRight.push(keyRight);\n  camera.gamepadAngularSensibility = 100;\n  if (runningSmartphone()) {\n    camera.inputs.addVirtualJoystick();\n  }\n\n  camera.speed = 1.0;\n  camera.inertia = 0.9;\n  camera.minZ = 0.1;\n  camera.maxZ = 10000;\n  camera.fov = 0.9;\n};\n\nexport const createCamera = (\n  name: string,\n  position: Vector3,\n  scene: Scene\n): RelativisticCamera => {\n  const camera = new RelativisticUniversalCamera(name, position, scene);\n  initCamera(camera);\n  return camera;\n};\n","import { DirectionalLight, ShaderMaterial, Vector3 } from \"@babylonjs/core\";\nimport { RelativisticCamera } from \"./camera\";\nimport { getState, SimultaneityFrame } from \"./ui\";\n\nexport type UniformParams = {\n  int?: Record<string, number>;\n  float?: Record<string, number>;\n  vec3?: Record<string, Vector3>;\n};\n\nconst ticks = () => {\n  return new Date().getTime();\n};\n\nconst start = ticks();\n\nexport const definesFromUiState = () => {\n  const {\n    galilean,\n    simultaneityFrame,\n    useFixedVelocity,\n    useNoTimeDelay,\n    relativisticBeaming,\n    dopplerEffect,\n    timePulse,\n  } = getState();\n  const defines = [\n    galilean ? \"#define GALILEAN\" : \"\",\n    useNoTimeDelay\n      ? simultaneityFrame == SimultaneityFrame.world\n        ? \"#define SIMULTANEITY_FRAME_WORLD\"\n        : \"#define SIMULTANEITY_FRAME_CAMERA\"\n      : \"\",\n    useFixedVelocity ? \"#define FIXED_VELOCITY\" : \"\",\n    useNoTimeDelay ? \"#define NO_TIME_DELAY\" : \"\",\n    relativisticBeaming ? \"#define RELATIVISTIC_BEAMING\" : \"\",\n    dopplerEffect ? \"#define DOPPLER_EFFECT\" : \"\",\n    timePulse ? \"#define TIME_PULSE\" : \"\",\n  ];\n  return defines;\n};\n\n/**\n * Get uniform parameters for shader from UI and camera.\n */\nexport const getUniformParams = (\n  camera: RelativisticCamera,\n  light: DirectionalLight\n) => {\n  const {\n    cameraBeta,\n    galilean,\n    simultaneityFrame,\n    useFixedVelocity,\n    useNoTimeDelay,\n    relativisticBeaming,\n    dopplerEffect,\n    timePulse,\n  } = getState();\n  const velocity =\n    camera.velocity == null || useFixedVelocity\n      ? camera.getDirection(Vector3.Forward()).scale(cameraBeta)\n      : camera.velocity;\n  const speed = velocity.length();\n  const gamma = galilean ? 1 : 1 / Math.sqrt(1 - speed * speed);\n  light.computeTransformedInformation();\n  const lightDir = light.transformedDirection ?? light.direction;\n  lightDir && lightDir.normalize();\n  return {\n    vec3: {\n      velocity,\n      lightDir,\n    },\n    float: {\n      time: (ticks() - start) / 1000,\n      gamma,\n    },\n    int: {\n      useNoTimeDelay: useNoTimeDelay ? 1 : 0,\n      simultaneityFrame,\n      useGalilean: galilean ? 1 : 0,\n      relativisticBeaming: relativisticBeaming ? 1 : 0,\n      dopplerEffect: dopplerEffect ? 1 : 0,\n      timePulse: timePulse ? 1 : 0,\n    },\n  };\n};\n\n/** Convenience function for setting a bunch of uniforms on a shader. */\nexport const setUniforms = (shader: ShaderMaterial, data: UniformParams) => {\n  if (data.int != null) {\n    Object.entries(data.int).forEach(([uniformName, uniformValue]) => {\n      shader.setInt(uniformName, uniformValue);\n    });\n  }\n  if (data.vec3 != null) {\n    Object.entries(data.vec3).forEach(([uniformName, uniformValue]) => {\n      shader.setVector3(uniformName, uniformValue);\n    });\n  }\n  if (data.float != null) {\n    Object.entries(data.float).forEach(([uniformName, uniformValue]) => {\n      shader.setFloat(uniformName, uniformValue);\n    });\n  }\n};\n","import {\n  Scene,\n  BaseTexture,\n  Material,\n  AbstractMesh,\n  PBRMaterial,\n  BackgroundMaterial,\n  ShaderMaterial,\n  InstancedMesh,\n  VertexBuffer,\n  Vector3,\n} from \"@babylonjs/core\";\nimport { UniformParams, setUniforms } from \"./utils\";\n\nexport type ShaderConfig = {\n  scene: Scene;\n  rgbMapTexture: BaseTexture;\n};\n\n/** Initialize the special relativity shaders. */\nexport const initShaders = ({ scene, rgbMapTexture }: ShaderConfig) => {\n  const validMeshes = scene.meshes.filter(\n    (mesh) => !(mesh instanceof InstancedMesh) && mesh.material != null\n  );\n  const materials = validMeshes.map((mesh) => mesh.material);\n  const definesChange = (defines: string[]) => {\n    for (let i = 0; i < materials.length; i++) {\n      const material = materials[i];\n      const mesh = validMeshes[i];\n      updateShaderMaterial(scene, rgbMapTexture, material!, mesh, defines);\n    }\n  };\n  const uniformsChange = (uniforms: UniformParams) => {\n    for (let i = 0; i < materials.length; i++) {\n      const mesh = validMeshes[i];\n      const material = materials[i];\n      const shaderMaterial = mesh.material;\n      // TODO: Add better support for animations.\n      // Should really be able to specify a velocity\n      // inside the GLTF file instead of using animation.\n      if (mesh.parent?.name === \"Empty\") {\n        const v1 = uniforms.vec3?.[\"velocity\"];\n        if (v1 != null) {\n          const v2 = new Vector3(0, 0, -0.95);\n          uniforms.vec3![\"objectVelocity\"] = v2;\n        }\n      } else {\n        uniforms.vec3![\"objectVelocity\"] = Vector3.Zero();\n      }\n      if (!(shaderMaterial instanceof ShaderMaterial)) {\n        continue;\n      }\n      setUniforms(shaderMaterial, uniforms);\n      if (material == null) {\n        continue;\n      }\n    }\n  };\n  return {\n    definesChange,\n    uniformsChange,\n  };\n};\n\nconst updateShaderUniforms = (material: Material, shader: ShaderMaterial) => {\n  const uniformParams: UniformParams = {\n    float: {},\n    int: {},\n    vec3: {},\n  };\n  if (material instanceof PBRMaterial) {\n    uniformParams.float![\"metallicFactor\"] = material.metallic ?? 1;\n    uniformParams.float![\"roughnessFactor\"] = material.roughness ?? 1;\n  }\n  setUniforms(shader, uniformParams);\n};\n\nconst updateShaderMaterial = (\n  scene: Scene,\n  rgbMapTexture: BaseTexture,\n  material: Material,\n  mesh: AbstractMesh,\n  userDefines: string[]\n) => {\n  const samplers: Record<string, BaseTexture> = {};\n  const defines = [...userDefines];\n  if (material instanceof PBRMaterial) {\n    // Take the pre-defined samplers.\n    if (material.albedoTexture != null) {\n      samplers[\"albedoSampler\"] = material.albedoTexture;\n      defines.push(\"#define ALBEDO_ENABLED\");\n    }\n    if (material.bumpTexture != null) {\n      samplers[\"bumpSampler\"] = material.bumpTexture;\n      defines.push(\"#define BUMP_ENABLED\");\n      if (mesh.isVerticesDataPresent(VertexBuffer.TangentKind)) {\n        defines.push(\"#define TANGENT\");\n      }\n    }\n    if (material.metallicTexture != null) {\n      samplers[\"metallicRoughnessSampler\"] = material.metallicTexture;\n      defines.push(\"#define METALLIC_ROUGHNESS_ENABLED\");\n    }\n  } else if (material instanceof BackgroundMaterial) {\n    if (material.reflectionTexture != null) {\n      samplers[\"reflectionSampler\"] = material.reflectionTexture;\n    }\n    defines.push(\"#define SKYBOX\");\n  }\n  samplers[\"rgbMapSampler\"] = rgbMapTexture;\n  const shaderMaterial = new ShaderMaterial(\n    \"shader\" + mesh.name,\n    scene,\n    {\n      vertex: \"custom\",\n      fragment: \"custom\",\n    },\n    {\n      attributes: [\"position\", \"normal\", \"tangent\", \"uv\"],\n      uniforms: [\n        \"world\",\n        \"finalWorld\",\n        \"view\",\n        \"projection\",\n        \"velocity\",\n        \"time\",\n        \"lightDir\",\n        \"metallicFactor\",\n        \"roughnessFactor\",\n        \"cameraPosition\",\n        \"objectVelocity\"\n      ],\n      samplers: Object.keys(samplers),\n      defines,\n    }\n  );\n  Object.entries(samplers).map(([name, texture]) => {\n    shaderMaterial.setTexture(name, texture);\n  });\n  updateShaderUniforms(material, shaderMaterial);\n  // If there's already a shadermaterial, then we delete it.\n  if (mesh.material instanceof ShaderMaterial) {\n    mesh.material.dispose();\n  }\n  mesh.material = shaderMaterial;\n};\n","import {\n  Effect,\n  Engine,\n  SceneLoader,\n  Vector3,\n  Texture,\n  DirectionalLight,\n} from \"@babylonjs/core\";\nimport \"@babylonjs/loaders/glTF/2.0\";\nimport { createCanvas } from \"./canvas-utils\";\nimport { loadText } from \"./load-text\";\nimport { getState, initUi, initSpeedIndicator, getSceneUrl } from \"./ui\";\nimport { createCamera } from \"./camera\";\nimport { initSkybox } from \"./skybox\";\nimport { definesFromUiState, getUniformParams } from \"./utils\";\nimport { initShaders } from \"./shaders\";\n\ntype Config = {\n  el: HTMLElement;\n  sceneFilename: string;\n};\n\nconst main = async ({ el, sceneFilename }: Config) => {\n  const canvas = createCanvas(el);\n\n  const speedIndicator = initSpeedIndicator(el);\n\n  const [vertexSource, fragmentSource] = await Promise.all([\n    loadText(\"main.vert\"),\n    loadText(\"main.frag\"),\n  ]);\n\n  const engine = new Engine(canvas, true);\n\n  Effect.ShadersStore[\"customVertexShader\"] = vertexSource;\n\n  Effect.ShadersStore[\"customFragmentShader\"] = fragmentSource;\n\n  const scene = await SceneLoader.LoadAsync(sceneFilename);\n\n  const directionalLights = (scene.lights || []).filter(\n    (light) => light instanceof DirectionalLight\n  ) as DirectionalLight[];\n  if (directionalLights.length === 0) {\n    const position = new Vector3(3, -5, 4);\n    const light = new DirectionalLight(\"dir-light\", position, scene);\n    light.intensity = 10;\n    directionalLights.push(light);\n  }\n  const light = directionalLights[0];\n\n  // Find default camera in scene and replace it with relativistic camera.\n  const defaultCameraInfo =\n    scene.cameras && scene.cameras.length > 0 ? scene.cameras[0] : undefined;\n  const defaultPosition =\n    defaultCameraInfo?.globalPosition || new Vector3(0, 0, 1);\n  const defaultRotation = defaultCameraInfo?.absoluteRotation;\n  if (defaultCameraInfo != null) {\n    scene.removeCamera(defaultCameraInfo);\n  }\n  const camera = createCamera(\"camera1\", defaultPosition, scene);\n  scene.activeCamera = camera;\n\n  if (defaultRotation != null) {\n    camera.rotationQuaternion = defaultRotation;\n    // This is needed due to virtual joystick not handling\n    // certain rotations correctly.\n    camera.setTarget(camera.getFrontPosition(1));\n  } else {\n    camera.setTarget(Vector3.Zero());\n  }\n  // This attaches the camera to the canvas\n  camera.attachControl(true);\n\n  const rgbMapTexture = new Texture(\n    \"./lambda_rgb_map.png\",\n    scene,\n    false,\n    undefined,\n    Texture.BILINEAR_SAMPLINGMODE\n  );\n\n  // Need to skip this due to movement of vertices from relativistic\n  // corrections.\n  scene.skipFrustumClipping = true;\n  await initSkybox(scene);\n\n  const { definesChange, uniformsChange } = initShaders({\n    scene,\n    rgbMapTexture,\n  });\n\n  initUi({\n    el,\n    onStateChange: () => {\n      definesChange(definesFromUiState());\n    },\n  });\n\n  engine.onBeginFrameObservable.addOnce(() => {\n    // Set relevant defines for the first render.\n    definesChange(definesFromUiState());\n  });\n\n  // Register a render loop to repeatedly render the scene.\n  engine.runRenderLoop(function () {\n    const { cameraBeta } = getState();\n    // Set the maximum allowed speed.\n    camera.setMaxSpeed(cameraBeta);\n    const uniformParams = getUniformParams(camera, light);\n    uniformsChange(uniformParams);\n\n    const speed = uniformParams.vec3.velocity.length();\n    const gamma = uniformParams.float.gamma;\n    // Set the speed indicator in the UI.\n    speedIndicator.innerHTML = [\n      `Speed: ${speed.toFixed(3)}c`,\n      `Gamma: ${gamma.toFixed(3)}`,\n    ].join(\"<br/>\");\n    scene.render();\n  });\n\n  // Watch for browser/canvas resize events\n  window.addEventListener(\"resize\", function () {\n    engine.resize();\n  });\n  canvas.focus();\n};\n\nmain({\n  el: document.body,\n  sceneFilename: getSceneUrl(),\n}).catch(console.error);\n","import { Texture, Scene, EquiRectangularCubeTexture } from \"@babylonjs/core\";\n\nexport const initSkybox = async (scene: Scene) => {\n  const cubeTexture = new EquiRectangularCubeTexture(\n    \"space/starmap_2020.jpg\",\n    scene,\n    1024\n  );\n\n  cubeTexture.coordinatesMode = Texture.SKYBOX_MODE;\n  scene.createDefaultEnvironment({\n    createGround: false,\n    skyboxSize: 1000,\n    groundSize: 1000,\n    skyboxTexture: cubeTexture,\n  });\n};\n"],"names":["loadText","async","url","resp","fetch","ok","Error","statusText","text","diceUrl","defaultUiState","cameraBeta","useFixedVelocity","useNoTimeDelay","galilean","simultaneityFrame","relativisticBeaming","dopplerEffect","timePulse","getState","sessionStorage","uiState","JSON","parse","createToggle","attributeName","label","save","toggle","document","createElement","type","checked","addEventListener","e","target","HTMLInputElement","toggleLabel","appendChild","append","createRadioPicker","el","id","options","onChange","buttons","map","value","button","name","String","containerEl","idx","length","labelEl","forEach","onclick","setValue","buttonValue","setDisabled","disabled","getSceneUrl","relativityScene","RelativisticUniversalCamera","velocity","properVelocity","properAcceleration","dt","maxProperSpeed2","dragCoefficient","setMaxSpeed","speed","this","undefined","maxSpeed2","gamma2","Math","pow","constructor","position","scene","super","onAfterCheckInputsObservable","add","_camera","_eventState","copyFrom","cameraDirection","drag","normalizeToNew","scale","inertia","sqrt","subtractInPlace","addInPlace","properSpeed2","lengthSquared","normalize","scaleInPlace","invGamma","scaleToRef","ags","animationGroups","speedRatio","_computeLocalCameraSpeed","_checkInputs","engine","getEngine","getDeltaTime","getFps","setAll","cameraRotation","exp","_updatePosition","ticks","Date","getTime","start","definesFromUiState","setUniforms","shader","data","int","Object","entries","uniformName","uniformValue","setInt","vec3","setVector3","float","setFloat","updateShaderMaterial","rgbMapTexture","material","mesh","userDefines","samplers","defines","albedoTexture","push","bumpTexture","isVerticesDataPresent","metallicTexture","reflectionTexture","shaderMaterial","vertex","fragment","attributes","uniforms","keys","texture","setTexture","uniformParams","metallic","roughness","updateShaderUniforms","dispose","sceneFilename","canvas","style","width","clientWidth","height","clientHeight","tabIndex","window","_e","createCanvas","speedIndicator","classList","initSpeedIndicator","vertexSource","fragmentSource","Promise","all","directionalLights","lights","filter","light","intensity","defaultCameraInfo","cameras","defaultPosition","globalPosition","defaultRotation","absoluteRotation","removeCamera","camera","keysDownward","keysDown","keysUpward","keysUp","keysLeft","keysRight","gamepadAngularSensibility","navigator","userAgent","match","inputs","addVirtualJoystick","minZ","maxZ","fov","initCamera","createCamera","activeCamera","rotationQuaternion","setTarget","getFrontPosition","attachControl","skipFrustumClipping","cubeTexture","coordinatesMode","createDefaultEnvironment","createGround","skyboxSize","groundSize","skyboxTexture","initSkybox","definesChange","uniformsChange","validMeshes","meshes","materials","i","parent","v1","v2","initShaders","onStateChange","stringify","slider","min","max","step","inputMode","toString","title","createSpeedSlider","currValue","parseFloat","Number","isNaN","fixedSpeedToggleLabel","galileanToggleLabel","relativisticBeamingToggleLabel","dopplerEffectToggleLabel","timePulseToggleLabel","sliderLabel","simultaneityPicker","saveState","createSimultaneityPicker","scenePicker","location","reload","createScenePicker","uiEl","className","summaryEl","innerText","helptext","initUi","onBeginFrameObservable","addOnce","runRenderLoop","getDirection","gamma","computeTransformedInformation","lightDir","transformedDirection","direction","time","useGalilean","getUniformParams","innerHTML","toFixed","join","render","resize","focus","main","body","catch","console","error"],"sourceRoot":""}